<!-- Tab: Tools Management -->
<div id="tools-tab" class="tab-content">
    <!-- yt-dlp Management Section -->
    <div class="card">
        <h2>🎬 yt-dlp Management</h2>
        <p class="info-text">
            Manage your yt-dlp installation. Keep it updated to ensure compatibility with YouTube and other services.
        </p>

        <!-- Version Info -->
        <div class="version-info">
            <div class="version-item">
                <label>Current Version:</label>
                <span id="ytdlp-current-version" class="version-badge loading">Checking...</span>
            </div>
            <div class="version-item">
                <label>Latest Version:</label>
                <span id="ytdlp-latest-version" class="version-badge loading">Checking...</span>
            </div>
            <div class="version-item">
                <label>Status:</label>
                <span id="ytdlp-update-status" class="status-badge loading">Checking...</span>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button id="ytdlp-check-version-btn" class="btn btn-secondary">
                🔄 Check for Updates
            </button>
            <button id="ytdlp-upgrade-btn" class="btn btn-primary" disabled>
                ⬆️ Upgrade yt-dlp
            </button>
        </div>

        <!-- Output Log -->
        <div class="output-container" id="ytdlp-output" style="display: none;">
            <h3>Output Log</h3>
            <pre id="ytdlp-output-log"></pre>
        </div>
    </div>

    <!-- FFmpeg Management Section -->
    <div class="card">
        <h2>🎞️ FFmpeg Management</h2>
        <p class="info-text">
            Check your FFmpeg installation. FFmpeg is required for audio conversion.
        </p>

        <!-- Version Info -->
        <div class="version-info">
            <div class="version-item">
                <label>Current Version:</label>
                <span id="ffmpeg-current-version" class="version-badge loading">Checking...</span>
            </div>
            <div class="version-item">
                <label>Status:</label>
                <span id="ffmpeg-status" class="status-badge loading">Checking...</span>
            </div>
            <div class="version-item" id="docker-info-item" style="display: none;">
                <label>Environment:</label>
                <span id="environment-badge" class="version-badge">🐳 Docker Container</span>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button id="ffmpeg-check-btn" class="btn btn-secondary">
                🔄 Check FFmpeg
            </button>
            <button id="ffmpeg-download-btn" class="btn btn-info">
                📥 Download FFmpeg
            </button>
        </div>

        <!-- FFmpeg Info (Non-Docker) -->
        <div class="info-box" id="ffmpeg-info-standard">
            <p><strong>Note:</strong> FFmpeg must be installed separately and available in your system PATH.</p>
            <p>Download from: <a href="https://ffmpeg.org/download.html" target="_blank">https://ffmpeg.org/download.html</a></p>
            <p><strong>Windows Users:</strong> Download the "essentials" build and extract ffmpeg.exe to a folder in your PATH.</p>
        </div>

        <!-- FFmpeg Info (Docker) -->
        <div class="info-box docker-info" id="ffmpeg-info-docker" style="display: none;">
            <p><strong>🐳 Docker Environment Detected</strong></p>
            <p>In Docker, FFmpeg should be included in your container image. To update FFmpeg:</p>
            <ol>
                <li><strong>Update your Dockerfile:</strong> Ensure FFmpeg is installed in the base image</li>
                <li><strong>Rebuild the container:</strong> <code>docker-compose build</code></li>
                <li><strong>Restart the container:</strong> <code>docker-compose up -d</code></li>
            </ol>
            <p><strong>Example Dockerfile snippet:</strong></p>
            <pre>RUN apt-get update && apt-get install -y ffmpeg</pre>
        </div>
    </div>

    <!-- Info Cards -->
    <div class="card">
        <h3>📚 Why Keep Tools Updated?</h3>
        <div class="info-grid">
            <div class="info-card">
                <h4>yt-dlp</h4>
                <ul class="info-list">
                    <li><strong>YouTube Compatibility:</strong> YouTube frequently changes their API</li>
                    <li><strong>Bug Fixes:</strong> Regular stability improvements</li>
                    <li><strong>New Features:</strong> Support for additional services</li>
                    <li><strong>Security:</strong> Security patches and updates</li>
                </ul>
            </div>
            <div class="info-card">
                <h4>FFmpeg</h4>
                <ul class="info-list">
                    <li><strong>Audio Conversion:</strong> Convert downloaded files to desired format</li>
                    <li><strong>Quality:</strong> Control bitrate and audio quality</li>
                    <li><strong>Metadata:</strong> Embed album art and tags</li>
                    <li><strong>Compatibility:</strong> Support for all audio formats</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Troubleshooting -->
    <div class="card">
        <h3>🔧 Troubleshooting</h3>
        <details>
            <summary>yt-dlp: Downloads are failing with "Precondition check failed" errors</summary>
            <p>This usually means your yt-dlp version is outdated. Click "Upgrade yt-dlp" above to fix this issue.</p>
        </details>
        <details>
            <summary>yt-dlp: Upgrade button is grayed out</summary>
            <p>The upgrade button is only enabled when a new version is available. Click "Check for Updates" to refresh the version information.</p>
        </details>
        <details>
            <summary>yt-dlp: Upgrade fails or times out</summary>
            <p>Try running the upgrade command manually in your terminal:</p>
            <code>pip install --upgrade --force-reinstall yt-dlp</code>
        </details>
        <details>
            <summary>FFmpeg: "FFmpeg not found" error</summary>
            <p>FFmpeg is not installed or not in your system PATH. Download FFmpeg from the official website and ensure ffmpeg.exe is accessible from the command line.</p>
        </details>
        <details>
            <summary>FFmpeg: How to add FFmpeg to PATH on Windows</summary>
            <p>1. Extract ffmpeg.exe to a folder (e.g., C:\ffmpeg\bin)</p>
            <p>2. Open System Properties → Environment Variables</p>
            <p>3. Edit the "Path" variable and add the ffmpeg folder</p>
            <p>4. Restart your terminal/command prompt</p>
        </details>
        <details>
            <summary>Docker: How to update FFmpeg in a container</summary>
            <p><strong>Method 1: Update Dockerfile</strong></p>
            <code># Add to your Dockerfile
RUN apt-get update && apt-get install -y ffmpeg

# Or for Alpine Linux
RUN apk add --no-cache ffmpeg</code>
            <p><strong>Method 2: docker-compose.yml</strong></p>
            <code>services:
  blissful:
    build: .
    # Rebuild with: docker-compose build
    # Restart with: docker-compose up -d</code>
            <p><strong>Method 3: Pre-built image with FFmpeg</strong></p>
            <code># Use a base image that includes FFmpeg
FROM python:3.12-slim
RUN apt-get update && apt-get install -y ffmpeg</code>
        </details>
        <details>
            <summary>Docker: yt-dlp updates in containers</summary>
            <p>In Docker, yt-dlp can be updated via pip (same as host):</p>
            <p>✅ <strong>Use the "Upgrade yt-dlp" button</strong> - it works in Docker!</p>
            <p>⚠️ <strong>Note:</strong> Updates are lost when container is rebuilt unless you:</p>
            <ol>
                <li>Add <code>RUN pip install --upgrade yt-dlp</code> to your Dockerfile</li>
                <li>Use a volume to persist Python packages</li>
                <li>Update yt-dlp during container build</li>
            </ol>
        </details>
    </div>
</div>

<style>
.version-info {
    background: var(--bg-secondary);
    border-radius: 8px;
    padding: 20px;
    margin: 20px 0;
}

.version-item {
    display: flex;
    align-items: center;
    margin: 10px 0;
    gap: 10px;
}

.version-item label {
    font-weight: 600;
    min-width: 130px;
    color: var(--text-secondary);
}

.version-badge, .status-badge {
    padding: 6px 12px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    font-weight: 600;
}

.version-badge.loading, .status-badge.loading {
    background: #6c757d;
    color: white;
}

.version-badge.current {
    background: #6366f1;
    color: white;
}

.version-badge.latest {
    background: #10b981;
    color: white;
}

.status-badge.up-to-date {
    background: #10b981;
    color: white;
}

.status-badge.installed {
    background: #10b981;
    color: white;
}

.status-badge.needs-update {
    background: #f59e0b;
    color: white;
}

.status-badge.not-installed {
    background: #ef4444;
    color: white;
}

.status-badge.error {
    background: #ef4444;
    color: white;
}

.action-buttons {
    display: flex;
    gap: 10px;
    margin: 20px 0;
    flex-wrap: wrap;
}

.output-container {
    margin-top: 20px;
    background: var(--bg-secondary);
    border-radius: 8px;
    padding: 15px;
}

.output-container h3 {
    margin-top: 0;
    color: var(--text-primary);
}

#ytdlp-output-log {
    background: #1e1e1e;
    color: #d4d4d4;
    padding: 15px;
    border-radius: 4px;
    max-height: 300px;
    overflow-y: auto;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    line-height: 1.5;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 15px;
}

.info-card {
    background: var(--bg-secondary);
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid var(--primary-color);
}

.info-card h4 {
    margin-top: 0;
    color: var(--primary-color);
}

.info-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.info-list li {
    padding: 8px 0;
    color: var(--text-secondary);
}

.info-list li strong {
    color: var(--text-primary);
}

.info-box {
    background: #fff3cd;
    border: 1px solid #ffc107;
    border-radius: 4px;
    padding: 15px;
    margin-top: 15px;
}

.info-box p {
    margin: 5px 0;
    color: #856404;
}

.info-box a {
    color: #0056b3;
    text-decoration: underline;
}

.info-box.docker-info {
    background: #d1ecf1;
    border: 1px solid #17a2b8;
}

.info-box.docker-info p {
    color: #0c5460;
}

.info-box.docker-info ol {
    margin: 10px 0;
    padding-left: 20px;
    color: #0c5460;
}

.info-box.docker-info pre {
    background: #1e1e1e;
    color: #d4d4d4;
    padding: 10px;
    border-radius: 4px;
    margin: 10px 0;
    overflow-x: auto;
}

#environment-badge {
    background: #17a2b8 !important;
    color: white;
}

details {
    background: var(--bg-secondary);
    padding: 15px;
    border-radius: 4px;
    margin: 10px 0;
    cursor: pointer;
}

details summary {
    font-weight: 600;
    color: var(--text-primary);
    user-select: none;
}

details p {
    margin-top: 10px;
    color: var(--text-secondary);
}

details code {
    display: block;
    background: #1e1e1e;
    color: #d4d4d4;
    padding: 10px;
    border-radius: 4px;
    margin-top: 10px;
    font-family: 'Courier New', monospace;
}

/* Button disabled state */
button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Loading spinner in button */
button.loading::before {
    content: "⏳ ";
}

/* Button variants */
.btn-info {
    background: #17a2b8;
}

.btn-info:hover {
    background: #138496;
}
</style>

<script>
// yt-dlp management functionality
(function() {
    const ytdlpCurrentVersionEl = document.getElementById('ytdlp-current-version');
    const ytdlpLatestVersionEl = document.getElementById('ytdlp-latest-version');
    const ytdlpUpdateStatusEl = document.getElementById('ytdlp-update-status');
    const ytdlpCheckVersionBtn = document.getElementById('ytdlp-check-version-btn');
    const ytdlpUpgradeBtn = document.getElementById('ytdlp-upgrade-btn');
    const ytdlpOutputContainer = document.getElementById('ytdlp-output');
    const ytdlpOutputLog = document.getElementById('ytdlp-output-log');

    // Check version on load
    checkYtdlpVersion();

    // Check version button
    ytdlpCheckVersionBtn.addEventListener('click', checkYtdlpVersion);

    // Upgrade button
    ytdlpUpgradeBtn.addEventListener('click', upgradeYtdlp);

    async function checkYtdlpVersion() {
        try {
            ytdlpCheckVersionBtn.disabled = true;
            ytdlpCheckVersionBtn.classList.add('loading');
            ytdlpCheckVersionBtn.textContent = ' Checking...';

            const response = await fetch('/api/ytdlp/version');
            const data = await response.json();

            if (data.success) {
                // Update current version
                ytdlpCurrentVersionEl.textContent = data.current_version;
                ytdlpCurrentVersionEl.className = 'version-badge current';

                // Update latest version
                ytdlpLatestVersionEl.textContent = data.latest_version;
                ytdlpLatestVersionEl.className = 'version-badge latest';

                // Update status
                if (data.needs_update) {
                    ytdlpUpdateStatusEl.textContent = 'Update Available';
                    ytdlpUpdateStatusEl.className = 'status-badge needs-update';
                    ytdlpUpgradeBtn.disabled = false;
                } else {
                    ytdlpUpdateStatusEl.textContent = 'Up to Date';
                    ytdlpUpdateStatusEl.className = 'status-badge up-to-date';
                    ytdlpUpgradeBtn.disabled = true;
                }
            } else {
                throw new Error(data.error || 'Failed to check version');
            }
        } catch (error) {
            console.error('Error checking yt-dlp version:', error);
            ytdlpUpdateStatusEl.textContent = 'Error: ' + error.message;
            ytdlpUpdateStatusEl.className = 'status-badge error';
            showNotification('Failed to check yt-dlp version', 'error');
        } finally {
            ytdlpCheckVersionBtn.disabled = false;
            ytdlpCheckVersionBtn.classList.remove('loading');
            ytdlpCheckVersionBtn.textContent = '🔄 Check for Updates';
        }
    }

    async function upgradeYtdlp() {
        if (!confirm('This will upgrade yt-dlp to the latest version. Continue?')) {
            return;
        }

        try {
            ytdlpUpgradeBtn.disabled = true;
            ytdlpUpgradeBtn.classList.add('loading');
            ytdlpUpgradeBtn.textContent = ' Upgrading...';

            // Show output container
            ytdlpOutputContainer.style.display = 'block';
            ytdlpOutputLog.textContent = 'Starting upgrade...\n';

            const response = await fetch('/api/ytdlp/upgrade', {
                method: 'POST'
            });

            const data = await response.json();

            if (data.success) {
                ytdlpOutputLog.textContent += '\n' + data.output + '\n';
                ytdlpOutputLog.textContent += `✓ Successfully upgraded to ${data.new_version}\n`;
                showNotification(`yt-dlp upgraded to ${data.new_version}`, 'success');

                // Refresh version info
                setTimeout(checkYtdlpVersion, 1000);
            } else {
                ytdlpOutputLog.textContent += '\n✗ Upgrade failed:\n' + data.output + '\n';
                throw new Error(data.error || 'Upgrade failed');
            }
        } catch (error) {
            console.error('Error upgrading yt-dlp:', error);
            ytdlpOutputLog.textContent += '\n✗ Error: ' + error.message + '\n';
            showNotification('Failed to upgrade yt-dlp', 'error');
        } finally {
            ytdlpUpgradeBtn.disabled = false;
            ytdlpUpgradeBtn.classList.remove('loading');
            ytdlpUpgradeBtn.textContent = '⬆️ Upgrade yt-dlp';
        }
    }
})();

// FFmpeg management functionality
(function() {
    const ffmpegCurrentVersionEl = document.getElementById('ffmpeg-current-version');
    const ffmpegStatusEl = document.getElementById('ffmpeg-status');
    const ffmpegCheckBtn = document.getElementById('ffmpeg-check-btn');
    const ffmpegDownloadBtn = document.getElementById('ffmpeg-download-btn');
    const dockerInfoItem = document.getElementById('docker-info-item');
    const ffmpegInfoStandard = document.getElementById('ffmpeg-info-standard');
    const ffmpegInfoDocker = document.getElementById('ffmpeg-info-docker');

    let isDockerEnvironment = false;

    // Check system info and FFmpeg on load
    checkSystemInfo();

    // Check button
    ffmpegCheckBtn.addEventListener('click', checkFFmpeg);

    // Download button
    ffmpegDownloadBtn.addEventListener('click', () => {
        if (isDockerEnvironment) {
            alert('In Docker, FFmpeg should be included in your container image. See instructions below.');
        } else {
            window.open('https://ffmpeg.org/download.html', '_blank');
        }
    });

    async function checkSystemInfo() {
        try {
            const response = await fetch('/api/system/info');
            const data = await response.json();

            if (data.success && data.is_docker) {
                isDockerEnvironment = true;
                dockerInfoItem.style.display = 'flex';
                ffmpegInfoStandard.style.display = 'none';
                ffmpegInfoDocker.style.display = 'block';
                ffmpegDownloadBtn.textContent = '📋 Docker Instructions';
            }
        } catch (error) {
            console.log('Could not detect Docker environment:', error);
        }

        // Check FFmpeg after system info
        checkFFmpeg();
    }

    async function checkFFmpeg() {
        try {
            ffmpegCheckBtn.disabled = true;
            ffmpegCheckBtn.classList.add('loading');
            ffmpegCheckBtn.textContent = ' Checking...';

            const response = await fetch('/api/health');
            const data = await response.json();

            if (data.ffmpeg_available) {
                // Try to get version from health check or make a separate call
                // For now, just show "Installed"
                ffmpegCurrentVersionEl.textContent = 'Installed';
                ffmpegCurrentVersionEl.className = 'version-badge current';
                
                ffmpegStatusEl.textContent = '✓ Available';
                ffmpegStatusEl.className = 'status-badge installed';
            } else {
                ffmpegCurrentVersionEl.textContent = 'Not Found';
                ffmpegCurrentVersionEl.className = 'version-badge error';
                
                ffmpegStatusEl.textContent = '✗ Not Installed';
                ffmpegStatusEl.className = 'status-badge not-installed';
            }
        } catch (error) {
            console.error('Error checking FFmpeg:', error);
            ffmpegStatusEl.textContent = 'Error';
            ffmpegStatusEl.className = 'status-badge error';
            showNotification('Failed to check FFmpeg', 'error');
        } finally {
            ffmpegCheckBtn.disabled = false;
            ffmpegCheckBtn.classList.remove('loading');
            ffmpegCheckBtn.textContent = '🔄 Check FFmpeg';
        }
    }
})();

function showNotification(message, type = 'info') {
    // Use existing notification system
    if (typeof window.showNotification === 'function') {
        window.showNotification(message, type);
    } else {
        alert(message);
    }
}
</script>
